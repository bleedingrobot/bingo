<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŸªğŸŸ©ğŸŸ¥ğŸŸ¦ V4 PD Bingo Multiplayer</title>
  <!-- Favicon (optional, replace with your favicon if you have one) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŸª</text></svg>">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <style>
    /* -- CSS omitted for brevity, copy from your original or ask for it explicitly -- */
    /* Paste your CSS here */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="rubik-cube">ğŸŸªğŸŸ©ğŸŸ¥ğŸŸ¦</span>
      <h1 style="display:inline;">PD Bingo</h1>
      <p>Challenge yourself with PD bingo boards and compete with friends in real time!</p>
    </div>
    <div id="mainMenu" class="main-menu">
      <div class="menu-card" onclick="showJoinGameModal()">
        <h3>ğŸš€ Join an Available Game</h3>
        <p>Pick from the list of available games and play!</p>
        <button class="btn btn-success">Join Game</button>
      </div>
      <div class="menu-card" onclick="showPlayerCreateGameModal()">
        <h3>ğŸŸ¦ Create Your Own Game</h3>
        <p>Make a PD bingo game for yourself and invite others!</p>
        <button class="btn btn-success">Create Game</button>
      </div>
      <div class="menu-card" onclick="showRejoinGameModal()">
        <h3>ğŸ”‘ Rejoin a Game</h3>
        <p>Rejoin a game you left earlier using your name and password.</p>
        <button class="btn">Rejoin Game</button>
      </div>
      <div class="menu-card" onclick="showLeaderboard()">
        <h3>ğŸ† Leaderboard</h3>
        <p>See how you stack up against other players</p>
        <button class="btn">View Scores</button>
      </div>
      <div class="menu-card" onclick="showAdminPanel()">
        <h3>ğŸ› ï¸ Admin Panel</h3>
        <p>Create or manage games/items (admin only)</p>
        <button class="btn btn-danger">Admin Tools</button>
      </div>
    </div>
    <div id="liveGamesSection"></div>

    <!-- JOIN GAME MODAL -->
    <div id="joinGameModal" class="modal">
      <div class="modal-content">
        <h2>ğŸš€ Join a Game</h2>
        <form id="joinGameForm">
          <div id="availableGamesList"></div>
          <div class="form-group" style="margin-top:12px;">
            <label for="playerNameJoin">Your Player Name:</label>
            <input type="text" id="playerNameJoin" required maxlength="20" placeholder="Enter your name">
          </div>
          <div class="form-group">
            <label for="playerPasswordJoin">Create a Password:</label>
            <input type="password" id="playerPasswordJoin" required maxlength="32" placeholder="Set a password">
          </div>
          <div class="form-group">
            <label for="playerPasswordJoin2">Confirm Password:</label>
            <input type="password" id="playerPasswordJoin2" required maxlength="32" placeholder="Repeat password">
          </div>
          <button type="submit" class="btn btn-success">Join Selected Game</button>
          <button type="button" class="btn" onclick="closeModal('joinGameModal')">Cancel</button>
        </form>
      </div>
    </div>
    <!-- REJOIN GAME MODAL -->
    <div id="rejoinGameModal" class="modal">
      <div class="modal-content">
        <h2>ğŸ”‘ Rejoin a Game</h2>
        <form id="rejoinGameForm">
          <div id="rejoinGamesList"></div>
          <div class="form-group" style="margin-top:12px;">
            <label for="playerNameRejoin">Your Player Name:</label>
            <input type="text" id="playerNameRejoin" required maxlength="20" placeholder="Enter your name">
          </div>
          <div class="form-group">
            <label for="playerPasswordRejoin">Your Password:</label>
            <input type="password" id="playerPasswordRejoin" required maxlength="32" placeholder="Enter your password">
          </div>
          <button type="submit" class="btn btn-success">Rejoin Selected Game</button>
          <button type="button" class="btn" onclick="closeModal('rejoinGameModal')">Cancel</button>
        </form>
      </div>
    </div>
    <!-- PLAYER CREATE GAME MODAL -->
    <div id="playerCreateGameModal" class="modal">
      <div class="modal-content">
        <h2>ğŸŸ¦ Create Your Own Game</h2>
        <form id="playerCreateGameForm">
          <div class="form-group">
            <label for="playerGameName">Game Name:</label>
            <input type="text" id="playerGameName" maxlength="40" required placeholder="e.g. My Custom Bingo">
          </div>
          <div class="form-group">
            <label for="playerNameCreator">Your Name:</label>
            <input type="text" id="playerNameCreator" maxlength="20" required placeholder="e.g. Alice">
          </div>
          <div class="form-group">
            <label for="playerPasswordCreator">Create a Password:</label>
            <input type="password" id="playerPasswordCreator" maxlength="32" required placeholder="Set a password">
          </div>
          <div class="form-group">
            <label for="playerPasswordCreator2">Confirm Password:</label>
            <input type="password" id="playerPasswordCreator2" maxlength="32" required placeholder="Repeat password">
          </div>
          <div class="form-group">
            <label for="playerDifficulty">Difficulty Level:</label>
            <select id="playerDifficulty">
              <option value="easy">ğŸŸ¢ Easy (3Ã—3 = 9 items)</option>
              <option value="normal">ğŸŸ¡ Normal (4Ã—5 = 20 items)</option>
              <option value="hard">ğŸŸ  Hard (5Ã—6 = 30 items)</option>
              <option value="epic">ğŸ”´ Epic (6Ã—6 = 36 items)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="playerTheme">Theme:</label>
            <select id="playerTheme">
              <option value="classic">ğŸ’™ Classic (Blue)</option>
              <option value="fire">ğŸ”¥ Fire (Red/Orange)</option>
              <option value="nature">ğŸŒ¿ Nature (Green)</option>
              <option value="royal">ğŸ‘‘ Royal (Purple)</option>
              <option value="neon">âš¡ Neon (Pink/Cyan)</option>
            </select>
          </div>
          <button type="submit" class="btn btn-success">Create Game</button>
          <button type="button" class="btn" onclick="closeModal('playerCreateGameModal')">Cancel</button>
        </form>
      </div>
    </div>
    <!-- LEADERBOARD SECTION -->
    <div id="leaderboard" style="display:none;">
      <div class="leaderboard">
        <h2>ğŸ† Leaderboard</h2>
        <div id="leaderboardTable">Loading...</div>
        <button class="btn" onclick="backToMenu()">Back to Menu</button>
      </div>
    </div>
    <!-- ADMIN PANEL SECTION -->
    <div id="adminPanel" style="display:none;">
      <div class="leaderboard">
        <h2>ğŸ› ï¸ Admin Panel</h2>
        <div>Admin features coming soon! (You can add your admin features here.)</div>
        <button class="btn" onclick="backToMenu()">Back to Menu</button>
      </div>
    </div>
    <div id="gameBoard" class="game-board" style="display:none;">
      <div class="game-header">
        <h2 id="gameTitle"></h2>
        <p id="gameSubtitle"></p>
      </div>
      <!-- Add the rest of your game board UI here -->
      <button class="btn" onclick="backToMenu()">Back to Menu</button>
    </div>
  </div>

  <script>
    // ==== Firebase INIT/SETUP ====
    const firebaseConfig = {
      apiKey: "AIzaSyDeQPS8fkc6uH9shQye35At98Fa5V62Z7A",
      authDomain: "bingo-e3517.firebaseapp.com",
      databaseURL: "https://bingo-e3517-default-rtdb.firebaseio.com",
      projectId: "bingo-e3517",
      storageBucket: "bingo-e3517.appspot.com",
      messagingSenderId: "338765367468",
      appId: "1:338765367468:web:9d539fe8e1b5351c123709",
      measurementId: "G-VFXRMS6LN7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    // CONSTANTS
    const GAMES_PATH = "bingo-multiplayer/games";
    const PLAYERS_PATH = "bingo-multiplayer/players";
    const DEFAULT_ITEMS = Array.from({length: 40}, (_,i)=>`PD Item ${i+1}`);
    const difficultySettings = {
      easy:   { emoji: "ğŸŸ¢", name: "Easy",   total: 9 },
      normal: { emoji: "ğŸŸ¡", name: "Normal", total: 20 },
      hard:   { emoji: "ğŸŸ ", name: "Hard",   total: 30 },
      epic:   { emoji: "ğŸ”´", name: "Epic",   total: 36 }
    };
    const themeSettings = {
      classic: { emoji: "ğŸ’™", name: "Classic" },
      fire:    { emoji: "ğŸ”¥", name: "Fire"    },
      nature:  { emoji: "ğŸŒ¿", name: "Nature"  },
      royal:   { emoji: "ğŸ‘‘", name: "Royal"   },
      neon:    { emoji: "âš¡", name: "Neon"    }
    };
    // App State
    let currentGame = null, currentGameId = null, currentPlayerId = null, currentPlayerName = null;

    // -- Helper functions --
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Hide/Show helpers
    function hideAllSections() {
      document.getElementById('mainMenu').style.display = 'none';
      let gameBoard = document.getElementById('gameBoard');
      if (gameBoard) gameBoard.style.display = 'none';
      document.getElementById('leaderboard').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'none';
    }
    window.backToMenu = function() {
      hideAllSections();
      document.getElementById('mainMenu').style.display = 'grid';
      document.body.className = '';
    };

    // --- Main Menu Buttons ---
    window.showLeaderboard = function() {
      hideAllSections();
      document.getElementById('leaderboard').style.display = 'block';
      loadLeaderboard();
    };
    window.showAdminPanel = function() {
      hideAllSections();
      document.getElementById('adminPanel').style.display = 'block';
    };

    // --- Join Game logic ---
    window.showJoinGameModal = function() {
      document.getElementById('joinGameModal').style.display = 'block';
      const listDiv = document.getElementById('availableGamesList');
      listDiv.innerHTML = "Loading games...";
      db.ref(GAMES_PATH).once('value').then(snapshot => {
        const games = snapshot.val() || {};
        let html = "";
        Object.values(games).filter(g=>g.isOpen).forEach(game => {
          html += `<div>
            <input type="radio" name="gameSelect" value="${game.id}" id="game_radio_${game.id}" required>
            <label for="game_radio_${game.id}"><b>${game.name}</b> - ${game.theme.emoji} ${game.theme.name}, ${game.difficulty.emoji} ${game.difficulty.name} [${game.items.length} items]</label>
          </div>`;
        });
        listDiv.innerHTML = html || "<div>No games available. Ask an admin to create one!</div>";
      });
    };
    function joinSelectedGame(e) {
      e.preventDefault();
      const playerName = document.getElementById('playerNameJoin').value.trim();
      const password = document.getElementById('playerPasswordJoin').value;
      const password2 = document.getElementById('playerPasswordJoin2').value;
      const gameId = (document.querySelector('input[name="gameSelect"]:checked')||{}).value;
      if (!playerName) return alert("Please enter your name!");
      if (!password) return alert("Please enter a password!");
      if (password.length < 3) return alert("Password should be at least 3 characters.");
      if (password !== password2) return alert("Passwords do not match!");
      if (!gameId) return alert("Please select a game!");
      db.ref(`${PLAYERS_PATH}/${gameId}`).once('value').then(playersSnap => {
        const players = playersSnap.val() || {};
        const existing = Object.values(players).find(p => p.name === playerName);
        if (existing) {
          alert("A player with that name already exists in this game. If it's you, use 'Rejoin Game'.");
          return;
        }
        joinGame(gameId, playerName, password);
        closeModal('joinGameModal');
      });
    }
    function joinGame(gameId, playerName, password) {
      db.ref(`${GAMES_PATH}/${gameId}`).once('value').then(snapshot => {
        const game = snapshot.val();
        if (!game) return alert("Game not found!");
        currentGame = game;
        currentGameId = gameId;
        currentPlayerName = playerName;
        currentPlayerId = playerName.replace(/\W/g,"") + "_" + Date.now();
        db.ref(`${PLAYERS_PATH}/${currentGameId}/${currentPlayerId}`).set({
          id: currentPlayerId,
          name: playerName,
          password: password,
          completedCount: 0,
          totalItems: game.items.length,
          completedItems: Array(game.items.length).fill(false),
          timestamp: Date.now()
        });
        showGameBoard(false, Array(game.items.length).fill(false));
      });
    }

    // --- Rejoin Game logic ---
    window.showRejoinGameModal = function() {
      document.getElementById('rejoinGameModal').style.display = 'block';
      const listDiv = document.getElementById('rejoinGamesList');
      listDiv.innerHTML = "Loading games...";
      db.ref(GAMES_PATH).once('value').then(snapshot => {
        const games = snapshot.val() || {};
        let html = "";
        Object.values(games).forEach(game => {
          html += `<div>
            <input type="radio" name="rejoinGameSelect" value="${game.id}" id="rejoin_radio_${game.id}" required>
            <label for="rejoin_radio_${game.id}"><b>${game.name}</b> - ${game.theme.emoji} ${game.theme.name}, ${game.difficulty.emoji} ${game.difficulty.name}</label>
          </div>`;
        });
        listDiv.innerHTML = html || "<div>No games available. Ask an admin to create one!</div>";
      });
    };
    function rejoinSelectedGame(e) {
      e.preventDefault();
      const playerName = document.getElementById('playerNameRejoin').value.trim();
      const password = document.getElementById('playerPasswordRejoin').value;
      const gameId = (document.querySelector('input[name="rejoinGameSelect"]:checked')||{}).value;
      if (!playerName) return alert("Please enter your name!");
      if (!password) return alert("Please enter your password!");
      if (!gameId) return alert("Please select a game!");
      db.ref(`${PLAYERS_PATH}/${gameId}`).once('value').then(playersSnap => {
        const players = playersSnap.val() || {};
        const foundEntry = Object.values(players).find(p => p.name === playerName);
        if (!foundEntry) {
          alert("No player with that name found in this game.");
          return;
        }
        if (foundEntry.password !== password) {
          alert("Incorrect password.");
          return;
        }
        currentGameId = gameId;
        currentPlayerId = foundEntry.id;
        currentPlayerName = foundEntry.name;
        db.ref(`${GAMES_PATH}/${gameId}`).once('value').then(gSnap => {
          currentGame = gSnap.val();
          showGameBoard(true, foundEntry.completedItems || Array(currentGame.items.length).fill(false));
        });
        closeModal('rejoinGameModal');
      });
    }

    // --- Player Create Game logic (NO auto-join) ---
    window.showPlayerCreateGameModal = function() {
      document.getElementById('playerCreateGameModal').style.display = 'block';
    };
    function playerCreateGame(e) {
      e.preventDefault();
      const gameName = document.getElementById('playerGameName').value.trim();
      const playerName = document.getElementById('playerNameCreator').value.trim();
      const password = document.getElementById('playerPasswordCreator').value;
      const password2 = document.getElementById('playerPasswordCreator2').value;
      const difficulty = document.getElementById('playerDifficulty').value;
      const theme = document.getElementById('playerTheme').value;
      if (!gameName) return alert("Please enter a game name!");
      if (!playerName) return alert("Please enter your name!");
      if (!password) return alert("Please set a password!");
      if (password.length < 3) return alert("Password should be at least 3 characters.");
      if (password !== password2) return alert("Passwords do not match!");
      db.ref("bingo-multiplayer/items").once('value').then(snap => {
        const itemsArr = snap.val() || DEFAULT_ITEMS;
        const diff = difficultySettings[difficulty];
        const thm = themeSettings[theme];
        const selectedItems = shuffleArray([...itemsArr]).slice(0, diff.total);
        const gameId = gameName.replace(/\W/g,"") + "_" + Date.now();
        db.ref(`bingo-multiplayer/games/${gameId}`).set({
          id: gameId,
          name: gameName,
          difficulty: diff,
          difficultyKey: difficulty,
          theme: thm,
          themeKey: theme,
          items: selectedItems,
          created: new Date().toISOString(),
          isOpen: true
        }).then(()=>{
          closeModal('playerCreateGameModal');
          alert("Game created! You can now join your game from the main menu.");
        });
      });
    }

    // --- Game Board handling: restore checklist state on join/rejoin ---
    function showGameBoard(isRejoin = false, completedItems = []) {
      hideAllSections();
      let gameBoard = document.getElementById('gameBoard');
      if (gameBoard) gameBoard.style.display = 'block';
      document.body.className = `theme-${currentGame.themeKey}`;
      document.getElementById('gameTitle').textContent = `ğŸŸ¦ ${currentGame.name}`;
      document.getElementById('gameSubtitle').textContent =
        `${currentGame.difficulty.emoji} ${currentGame.difficulty.name} â€¢ ${currentGame.theme.emoji} ${currentGame.theme.name}`;
      // TODO: Add/restore checklist UI if needed
    }

    // --- Leaderboard loader ---
    function loadLeaderboard() {
      const leaderboardTable = document.getElementById('leaderboardTable');
      leaderboardTable.innerHTML = "Loading...";
      db.ref(PLAYERS_PATH).once('value').then(snap => {
        const allPlayers = [];
        snap.forEach(gameSnap => {
          const gamePlayers = gameSnap.val();
          if (typeof gamePlayers === 'object') {
            Object.values(gamePlayers).forEach(player => {
              allPlayers.push({
                name: player.name,
                completedCount: player.completedCount || 0,
                totalItems: player.totalItems || 0
              });
            });
          }
        });
        allPlayers.sort((a,b) => (b.completedCount/b.totalItems)-(a.completedCount/a.totalItems));
        let html = `<table class="leaderboard-table">
          <tr><th>Player</th><th>Completed</th><th>Total</th><th>%</th></tr>`;
        for (let p of allPlayers) {
          const pct = p.totalItems ? Math.round(100*p.completedCount/p.totalItems) : 0;
          html += `<tr><td>${p.name}</td><td>${p.completedCount}</td><td>${p.totalItems}</td><td>${pct}%</td></tr>`;
        }
        html += `</table>`;
        leaderboardTable.innerHTML = html;
      });
    }

    // --- Modal close helper ---
    window.closeModal = function(id) {
      document.getElementById(id).style.display = 'none';
    };

    // --- Attach form event listeners on DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', ()=>{
      window.backToMenu();
      document.getElementById('joinGameForm').addEventListener('submit', joinSelectedGame);
      document.getElementById('rejoinGameForm').addEventListener('submit', rejoinSelectedGame);
      document.getElementById('playerCreateGameForm').addEventListener('submit', playerCreateGame);
    });
  </script>
</body>
</html>
